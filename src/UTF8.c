#include "UTF8.h"
#include "Utils.h"  // UTF_LOGGING

// UTF8
u8 bUTF8 = FALSE;
static u8 UTF_Buffer[4] = {0,0,0,0};
static u8 UTF_Seq = 0;

const u8 UTFTB[15][64] =
{
// 0x94 (Pos: 0x00)
{
    // 0     1     2     3     4     5     6     7     8     9     A     B     C     D     E     F
    0xC4, 0xC4, 0xB3, 0xB3, 0xC4, 0xC4, 0xB3, 0xB3, 0xC4, 0xC4, 0xB3, 0xB3, 0xDA, 0xDA, 0xDA, 0xDA, // 80-8F
    0xBF, 0xBF, 0xBF, 0xBF, 0xC0, 0xC0, 0xC0, 0xC0, 0xD9, 0xD9, 0xD9, 0xD9, 0xC3, 0xC3, 0xC3, 0xC3, // 90-9F
    0xC3, 0xC3, 0xC3, 0xC3, 0xB4, 0xB4, 0xB4, 0xB4, 0xB4, 0xB4, 0xB4, 0xB4, 0xC2, 0x00, 0x00, 0x00, // A0-AF    AC = 0xC2
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xC5, 0x00, 0x00, 0x00, // B0-BF
},

// 0x95 (Pos: 0x01)
{
    // 0     1     2     3     4     5     6     7     8     9     A     B     C     D     E     F
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 80-8F
    0xCD, 0xBA, 0x00, 0x00, 0xC9, 0x00, 0x00, 0xBB, 0x00, 0x00, 0xC8, 0x00, 0x00, 0xBC, 0x00, 0x00, // 90-9F
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // A0-AF
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // B0-BF
},

// 0x96 (Pos: 0x02)
{
    // 0     1     2     3     4     5     6     7     8     9     A     B     C     D     E     F
    0xDF, 0x00, 0x00, 0x00, 0xDC, 0x00, 0x00, 0x00, 0xDB, 0x00, 0x00, 0x00, 0xDD, 0x00, 0x00, 0x00, // 80-8F
    0xDE, 0xB0, 0xB1, 0xB2, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 90-9F
    0xDA, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // A0-AF
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // B0-BF
},

// 0x97 (Pos: 0x03)
{
    // 0     1     2     3     4     5     6     7     8     9     A     B     C     D     E     F
    0x00, 0x00, 0x11, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 80-8F
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 90-9F
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // A0-AF
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // B0-BF
},

// 0x98 (Pos: 0x04)
{
    // 0     1     2     3     4     5     6     7     8     9     A     B     C     D     E     F
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 80-8F
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 90-9F
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // A0-AF
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // B0-BF
},

// 0x99 (Pos: 0x05)
{
    // 0     1     2     3     4     5     6     7     8     9     A     B     C     D     E     F
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 80-8F
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 90-9F
    0x06, 0x00, 0x00, 0x05, 0x00, 0x03, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // A0-AF
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // B0-BF
},

// 0x9A (Pos: 0x06)
{
    // 0     1     2     3     4     5     6     7     8     9     A     B     C     D     E     F
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 80-8F
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 90-9F
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // A0-AF
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // B0-BF
},

// 0x9B (Pos: 0x07)
{
    // 0     1     2     3     4     5     6     7     8     9     A     B     C     D     E     F
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 80-8F
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 90-9F
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // A0-AF
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // B0-BF
},

// 0x9C (Pos: 0x08)
{
    // 0     1     2     3     4     5     6     7     8     9     A     B     C     D     E     F
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 80-8F
    0x00, 0x00, 0x00, 0xFB, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 90-9F
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // A0-AF
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // B0-BF
},

// 0xBF (Pos: 0x09)
{
    // 0     1     2     3     4     5     6     7     8     9     A     B     C     D     E     F
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 80-8F
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 90-9F
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFE, 0x09, 0x00, // A0-AF
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // B0-BF
},

// Dummy/empty (Pos: 0x0A)
{
    //0   1    2    3    4    5    6    7    8    9    A    B    C    D    E    F
    ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', // 80-8F
    ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', // 90-9F
    ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', // A0-AF
    ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', // B0-BF
},

// 0x80 (Pos: 0x0B)
{
    // 0     1     2     3     4     5     6     7     8     9     A     B     C     D     E     F
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 80-8F
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 90-9F
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFA, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFE, 0x09, 0x00, // A0-AF
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // B0-BF
},

// 0xBB (Pos: 0x0C)
{
    // 0     1     2     3     4     5     6     7     8     9     A     B     C     D     E     F
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 80-8F
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 90-9F
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // A0-AF
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x20, // B0-BF    - $BF = U+2EFF
},

// 0x88 (Pos: 0x0D) - U+2190
{
    // 0     1     2     3     4     5     6     7     8     9     A     B     C     D     E     F
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 80-8F
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x5C, 0x2A, 0x09, 0x07, 0xFB, 0x00, 0x00, 0x00, 0x00, 0x00, // 90-9F
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // A0-AF
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // B0-BF
},

// 0x00 (Pos: 0x0E) - U+0000
{
    // 0     1     2     3     4     5     6     7     8     9     A     B     C     D     E     F
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 80-8F
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // 90-9F
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // A0-AF
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFA, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // B0-BF
},
};

u8 const * const UTF_TablePtr[256] =
{
    //        0            1            2            3            4            5            6            7            8            9            A            B            C            D            E            F
    UTFTB[0x0E], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], // 0x00-0x0F
    UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], // 0x10-0x1F
    UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], // 0x20-0x2F
    UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], // 0x30-0x3F
    UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], // 0x40-0x4F
    UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], // 0x50-0x5F
    UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], // 0x60-0x6F
    UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], // 0x70-0x7F

    UTFTB[0x0B], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0D], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], // 0x80-0x8F
    UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x00], UTFTB[0x01], UTFTB[0x02], UTFTB[0x03], UTFTB[0x04], UTFTB[0x05], UTFTB[0x06], UTFTB[0x07], UTFTB[0x08], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], // 0x90-0x9F
    UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], // 0xA0-0xAF
    UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0C], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x09], // 0xB0-0xBF
    UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], // 0xC0-0xCF
    UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], // 0xD0-0xDF
    UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], // 0xE0-0xEF
    UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], UTFTB[0x0A], // 0xF0-0xFF
};

void TTY_PrintChar(u8 c);


void UTF8_Init()
{
    bUTF8 = FALSE;
    UTF_Buffer[0] = 0;
    UTF_Buffer[1] = 0;
    UTF_Buffer[2] = 0;
    UTF_Buffer[3] = 0;
    UTF_Seq = 0;
}

// https://www.utf8-chartable.de/unicode-utf8-table.pl
// U+2500->
inline void DoUTF8(u8 byte)
{
    UTF_Buffer[UTF_Seq++] = byte;

    if (UTF_Seq >= 2)
    {
        u8 outchar = ' ';

        outchar = UTF_TablePtr[UTF_Buffer[0]][(UTF_Buffer[1]-0x80) & 0x3F];
        
        #ifdef UTF_LOGGING
        if ((outchar == 0) || (outchar == 0x20)) kprintf("Unfilled UTF8 character: $%X $%X", UTF_Buffer[0], UTF_Buffer[1]);
        #endif

        bUTF8 = FALSE;
        UTF_Seq = 0;
        UTF_Buffer[0] = 0;
        UTF_Buffer[1] = 0;

        TTY_PrintChar(outchar);
    }

    return;
}
